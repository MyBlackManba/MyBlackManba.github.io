<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>微信小程序后台开发实例 | welcome to here</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="做了前端，老师非要让我们搞后台。">
<meta property="og:type" content="article">
<meta property="og:title" content="微信小程序后台开发实例">
<meta property="og:url" content="http://yoursite.com/2017/12/12/微信小程序后台开发实例/index.html">
<meta property="og:site_name" content="welcome to here">
<meta property="og:description" content="做了前端，老师非要让我们搞后台。">
<meta property="og:image" content="http://i.imgur.com/WWpOTU1.png">
<meta property="og:image" content="http://i.imgur.com/M2uma7v.png">
<meta property="og:image" content="http://i.imgur.com/2gyIQwm.png">
<meta property="og:image" content="http://i.imgur.com/QpG8av9.png">
<meta property="og:image" content="http://i.imgur.com/DE86OOP.png">
<meta property="og:image" content="https://camo.githubusercontent.com/42a54378b361b71b42439f79c4d57995175e237d/687474703a2f2f692e696d6775722e636f6d2f653264376162502e706e67">
<meta property="og:image" content="http://i.imgur.com/tfN3D53.png">
<meta property="og:image" content="https://mp.weixin.qq.com/debug/wxadoc/dev/image/login.png?t=2017213">
<meta property="og:image" content="http://i.imgur.com/EDmizgf.png">
<meta property="og:image" content="http://i.imgur.com/391Bao5.png">
<meta property="og:image" content="https://pay.weixin.qq.com/wiki/doc/api/img/wxa-7-2.jpg">
<meta property="og:image" content="http://i.imgur.com/1gqrCsq.jpg">
<meta property="og:image" content="http://i.imgur.com/RJjeB0b.png">
<meta property="og:updated_time" content="2018-03-08T13:45:13.290Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微信小程序后台开发实例">
<meta name="twitter:description" content="做了前端，老师非要让我们搞后台。">
<meta name="twitter:image" content="http://i.imgur.com/WWpOTU1.png">
  
    <link rel="alternate" href="/atom.xml" title="welcome to here" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">welcome to here</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-微信小程序后台开发实例" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/12/微信小程序后台开发实例/" class="article-date">
  <time datetime="2017-12-12T09:51:25.000Z" itemprop="datePublished">2017-12-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      微信小程序后台开发实例
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>做了前端，老师非要让我们搞后台。<br><a id="more"></a></p>
<h1 id="微信小程序《赞赏》案例实战"><a href="#微信小程序《赞赏》案例实战" class="headerlink" title="微信小程序《赞赏》案例实战"></a>微信小程序《赞赏》案例实战</h1><p><em>麻雀案例，五脏俱全</em></p>
<h2 id="写在最前"><a href="#写在最前" class="headerlink" title="写在最前"></a>写在最前</h2><p>微信小程序推出以后，笔者在公司内部开过几场小程序开发培训课。出于培训课程需要，笔者以公众号“赞赏”功能作为需求，制作出一个《赞赏》DEMO。本案例涵盖前后端完整设计与代码讲解，其中包括2个小程序前端页面，3个后端JSON接口，涉及到的相关知识要点包括了登录、后端信息获取（AES-128-CBC解密算法）、微信支付、后端数据存储等，是个完整的麻雀案例。<br>案例借助开源NAMI框架（<a href="https://github.com/wodenwang/nami" target="_blank" rel="noopener">https://github.com/wodenwang/nami</a>），十分钟即可完成前后端本地部署。</p>
<p><strong>案例效果一览：</strong><br><img src="http://i.imgur.com/WWpOTU1.png" alt=""></p>
<h2 id="运行环境部署"><a href="#运行环境部署" class="headerlink" title="运行环境部署"></a>运行环境部署</h2><ol>
<li><p>下载源码：从github获取《赞赏》案例源码（地址：<a href="https://github.com/wodenwang/nami-demo-pay" target="_blank" rel="noopener">https://github.com/wodenwang/nami-demo-pay</a>），代码分为三部分，分别是：<strong>client，server，sql</strong>。</p>
</li>
<li><p>前端代码安装：打开微信开发工具，导入源码的<strong>client</strong>部分。（注意：必须填写appid，否则无法发起支付；勾选“不校验域名与TLS版本”方便本地调试）<br><img src="http://i.imgur.com/M2uma7v.png" alt=""></p>
</li>
<li><p>下载NAMI框架（<a href="https://github.com/wodenwang/nami" target="_blank" rel="noopener">https://github.com/wodenwang/nami</a>）：可自行编译，也可以从官方的云盘（<a href="http://pan.baidu.com/s/1bJmUtg" target="_blank" rel="noopener">http://pan.baidu.com/s/1bJmUtg</a>）直接下载编译完的版本（匹配操作系统，解压即可用）。<br><img src="http://i.imgur.com/2gyIQwm.png" alt=""></p>
</li>
<li><p>后端代码安装：将《赞赏》案例的<strong>server</strong>端源码拷贝到NAMI框架中，只需覆盖function与request两个目录即可。<br><img src="http://i.imgur.com/QpG8av9.png" alt=""></p>
</li>
<li><p>初始化数据库：双击NAMI的db.bat打开内置数据库控制台，执行<strong>sql</strong>中的h2.sql建表语句。<br><img src="http://i.imgur.com/DE86OOP.png" alt=""></p>
</li>
<li><p>修改NAMI/conf/wx.properties，设置小程序appid，appsecret，小程序支付的密匙、密匙文件路径等。<br><img src="https://camo.githubusercontent.com/42a54378b361b71b42439f79c4d57995175e237d/687474703a2f2f692e696d6775722e636f6d2f653264376162502e706e67" alt=""></p>
</li>
<li><p>好了，运行NAMI的start.bat，然后在微信开发工具中将/nami/config.js中的服务端路径修改成<a href="http://localhost:8080，即可运行DEMO。" target="_blank" rel="noopener">http://localhost:8080，即可运行DEMO。</a></p>
</li>
</ol>
<h2 id="小程序登录"><a href="#小程序登录" class="headerlink" title="小程序登录"></a>小程序登录</h2><p>微信公众平台（包括公众号、小程序）相比APP的一个明显优势，是开发者可以直接利用微信的用户鉴权体系，免去注册、密码登录的步骤。微信小程序对于登录的设计，更是用之于无形，在整个用户使用过程中都是无感知的，一进小程序其实就已经登录了。<br>也许有读者会说，小程序登录的时候不是会弹出一个用户信息的询问框吗？错了，这个询问框是调用wx.getUserInfo获取“用户资料”时候弹出的，调用wx.login的“登录”操作是不会弹出任何询问框的。<br><img src="http://i.imgur.com/tfN3D53.png" alt=""></p>
<p>关于微信小程序登录，官方文档的流程实现起来挺不容易的（如下图），需要服务端维护一个保存openid等用户资料的缓存池，同时小程序客户端还需要维护一个3rd session key，并且在之后每次做服务端请求的时候都要带入这个3rd session key。<br><img src="https://mp.weixin.qq.com/debug/wxadoc/dev/image/login.png?t=2017213" alt=""></p>
<p>所幸NAMI框架已经把这块封装好，下面我们用一点篇幅来看看案例是如何做login的。<br><br><br>1) app.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nami <span class="keyword">from</span> <span class="string">'/nami/index'</span>;</span><br><span class="line"></span><br><span class="line">App(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    userInfo: <span class="literal">null</span>,</span><br><span class="line">    rankLoaded: <span class="literal">false</span> <span class="comment">//排行榜已加载</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  onLaunch: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> app = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">//登录</span></span><br><span class="line">    nami.login(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      nami.getUserInfo(<span class="function">(<span class="params">userInfo</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"已获取数据"</span>, userInfo);</span><br><span class="line">        app.data.userInfo = userInfo;</span><br><span class="line">      &#125;, () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"用户拒绝提供信息"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>案例在小程序入口的时候实现nami封装的登录，登录成功之后可以看到localstorage中保存了一个叫做NAMI_TOKEN的字符，这个就是小程序登录之后要求前端保存的3rd session key了。<br><img src="http://i.imgur.com/EDmizgf.png" alt=""><br><br><br>2) rank.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *下拉刷新</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onPullDownRefresh: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      wx.stopPullDownRefresh();</span><br><span class="line">      <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line"><span class="comment">//这里使用了nami封装的request而不是wx.request</span></span><br><span class="line">      nami.request(&#123;</span><br><span class="line">          loading: <span class="literal">true</span>,</span><br><span class="line">          url: <span class="string">'/request/scholes_pay/rank.groovy'</span>,</span><br><span class="line">          success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">              that.setData(&#123;</span><br><span class="line">                  dataList: res.data.list</span><br><span class="line">              &#125;);</span><br><span class="line">              app.data.rankLoaded = <span class="literal">true</span>;<span class="comment">//加载完成</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure></p>
<p>截取一个服务端请求的代码片段做分析，发现NAMI框架将request也做了封装，其主要目的是在每次服务端请求的时候将localstorage中的NAMI_TOKEN带入，如图。<br><img src="http://i.imgur.com/391Bao5.png" alt=""><br><br><br>3） 服务端代码：rank.groovy<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 排行榜</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> woden</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//重点是这一句获取已登录的用户信息</span></span><br><span class="line"><span class="comment">//NAMI框架中通过nami_token在服务端缓存池找到对应的用户资料，并返回给逻辑代码</span></span><br><span class="line"><span class="comment">//这里的session指的是NAMI框架中封装的会话上下文</span></span><br><span class="line"><span class="keyword">def</span> user = session.appUser();</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据被赞赏金额排名的用户列表</span></span><br><span class="line"><span class="keyword">def</span> list = db.query(<span class="string">"""</span></span><br><span class="line"><span class="string">select b.*,a.TOTAL_FEE from</span></span><br><span class="line"><span class="string">(</span></span><br><span class="line"><span class="string">	select sum(TOTAL_FEE) TOTAL_FEE,OPEN_ID from PAY_DETAIL group by OPEN_ID</span></span><br><span class="line"><span class="string">) a </span></span><br><span class="line"><span class="string">left join PAY_USER b on a.OPEN_ID = b.OPEN_ID</span></span><br><span class="line"><span class="string">order by a.TOTAL_FEE desc,b.UPDATE_TIME asc </span></span><br><span class="line"><span class="string">limit 10</span></span><br><span class="line"><span class="string">"""</span>.toString());</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> result = [];</span><br><span class="line"><span class="keyword">def</span> i=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">def</span> <span class="string">o:</span>list)&#123;</span><br><span class="line">	<span class="keyword">def</span> vo = [:];</span><br><span class="line">	vo.avatar = o.AVATAR_URL;</span><br><span class="line">	vo.nickName = o.NICK_NAME;</span><br><span class="line">	vo.fee = fmt.formatPrice(o.TOTAL_FEE/<span class="number">100</span>);</span><br><span class="line">	<span class="keyword">if</span>(user.openId == o.OPEN_ID)&#123;</span><br><span class="line">		vo.my = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	vo.rank = i++;</span><br><span class="line">	result += vo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [<span class="string">list:</span>result];</span><br></pre></td></tr></table></figure></p>
<p>从这个案例看出，NAMI框架遵循规范推荐的技术原则，将缓存池、3rd key等业务无关的技术细节封装在框架中，让开发人员可以更专注于业务逻辑本身。</p>
<h2 id="小程序支付"><a href="#小程序支付" class="headerlink" title="小程序支付"></a>小程序支付</h2><p>小程序推出之初，许多开发人员对于小程序支付的实现也是焦头烂额，官方给出的时序图如下，读者可以自己感受一下。<br><img src="https://pay.weixin.qq.com/wiki/doc/api/img/wxa-7-2.jpg" alt=""><br><br><br>微信小程序的支付对于前端的接口倒是简单，只需事先一个wx.requestPayment接口，至于API里面指定的参数，填空就是了。先看看案例中前端支付是怎么写的。<br><br><br>1） index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 绑定选中赞赏金额按钮</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> selectItem: <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line"><span class="comment">//获取待支付金额，单位：元</span></span><br><span class="line">   <span class="keyword">var</span> total = event.currentTarget.dataset.item;</span><br><span class="line">   <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">   that.setData(&#123; <span class="attr">selected</span>: total &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//向服务端发起支付请求，获取wx.requestPayment需要的信息</span></span><br><span class="line">   nami.request(&#123;</span><br><span class="line">     loading: <span class="literal">true</span>,</span><br><span class="line">     url: <span class="string">'/request/scholes_pay/pay.groovy'</span>,</span><br><span class="line">     data: &#123;</span><br><span class="line">       total: total * <span class="number">100</span> <span class="comment">//元转为分</span></span><br><span class="line">     &#125;,</span><br><span class="line">     success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">"获取支付密匙"</span>, res);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//发起支付，根据服务端的返回填空</span></span><br><span class="line">       wx.requestPayment(&#123;</span><br><span class="line">         timeStamp: <span class="string">''</span> + res.data.signature.timestamp,</span><br><span class="line">         nonceStr: res.data.signature.nonce,</span><br><span class="line">         package: res.data.signature.pack,</span><br><span class="line">         signType: <span class="string">'MD5'</span>,</span><br><span class="line">         paySign: res.data.signature.signature,</span><br><span class="line">         success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">           app.data.rankLoaded = <span class="literal">false</span>;<span class="comment">//通知排行榜重新加载</span></span><br><span class="line">           wx.showToast(&#123;</span><br><span class="line">             title: <span class="string">'支付成功,感谢'</span>,</span><br><span class="line">             icon: <span class="string">'success'</span></span><br><span class="line">           &#125;);</span><br><span class="line">         &#125;,</span><br><span class="line">         fail: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">           wx.showToast(&#123;</span><br><span class="line">             title: <span class="string">'已取消支付'</span>,</span><br><span class="line">             icon: <span class="string">'success'</span></span><br><span class="line">           &#125;);</span><br><span class="line">         &#125;,</span><br><span class="line">         complete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">           that.setData(&#123; <span class="attr">selected</span>: <span class="number">0</span> &#125;);<span class="comment">//取消选中</span></span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">     &#125;,</span><br><span class="line">     fail: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//do anything</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码看出，调用wx.requestPayment之前需先请求服务端下单，并返回对应的支付密匙信息。好，接下来我们看看服务端下单的逻辑怎么写。<br><br><br>2） 服务端代码：pay.groovy<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下单支付</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> woden</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取当前用户</span></span><br><span class="line"><span class="keyword">def</span> user = session.appUser();</span><br><span class="line">log.debug(<span class="string">"user:&#123;&#125;"</span>,user);</span><br><span class="line"><span class="keyword">if</span>(!user?.nickName)&#123;</span><br><span class="line">	nami.error("用户拒绝提供资料,无法支付.");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//更新用户信息</span><br><span class="line">if(db.find("select OPEN_ID from PAY_USER where OPEN_ID=?",user.openId))&#123;//找得到则更新</span><br><span class="line">	db.exec("update PAY_USER set NICK_NAME=?,AVATAR_URL=?,UPDATE_TIME=? where OPEN_ID=?"</span><br><span class="line">			,user.nickName</span><br><span class="line">			,user.avatarUrl</span><br><span class="line">			,now</span><br><span class="line">			,user.openId</span><br><span class="line">			);</span><br><span class="line">&#125;else&#123;//否则新增</span><br><span class="line">	db.exec("insert into PAY_USER (OPEN_ID,NICK_NAME,AVATAR_URL,UPDATE_TIME) values (?,?,?,?)"</span><br><span class="line">			,user.openId</span><br><span class="line">			,user.nickName</span><br><span class="line">			,user.avatarUrl</span><br><span class="line">			,now</span><br><span class="line">			);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//支付下单</span><br><span class="line">//调用NAMI框架的app.pay.order接口(封装了微信支付下单)，直接获取订单order对象</span><br><span class="line">def total = request.getInteger("total");</span><br><span class="line">def order =app.pay.order([</span><br><span class="line">	openId : user.openId,</span><br><span class="line">	<span class="string">total :</span> total,</span><br><span class="line">	<span class="string">body :</span> <span class="string">'多谢赞赏'</span>,</span><br><span class="line">	<span class="string">notify :</span> nami.invoke(<span class="string">'host.groovy'</span>)+<span class="string">'/request/scholes_pay/pay_callback.groovy'</span> <span class="comment">//回调</span></span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//向客户端生成支付加密串</span></span><br><span class="line"><span class="comment">//调用NAMI框架的app.pay.signatur接口(根据prepayId换取支付密匙)</span></span><br><span class="line"><span class="keyword">return</span> [<span class="string">tradeNumber:</span>order.tradeNumber,<span class="string">signature:</span>app.pay.signature(order.prepayId)];</span><br></pre></td></tr></table></figure></p>
<p>这里NAMI有两个接口，分别是：</p>
<ul>
<li>app.pay.order：统一下单（<a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1）" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1）</a></li>
<li>app.pay.signatur：签名算法（<a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=4_3）" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=4_3）</a></li>
</ul>
<p>看，支付的例子再一次说明NAMI框架化繁为简，把接口调用、基于支付安全考虑的签名加密算法都封装好，让开发人员关注业务逻辑本身而非这些技术细节，这在实际项目开发的时候可以大大提升效率。</p>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p>即使开发这么小的案例，数数也踩了不少坑，除了像兼容性问题、工具BUG、各种组件BUG这种已经让开发者们“习以为常”的坑以外，我重点列几个被官方升级“升”出来的坑。</p>
<ul>
<li><strong>获取用户资料的确认框被“拒绝”后不再弹出，导致获取不到用户资料。</strong>调用wx.getUserInfo弹出询问框，假如点了“拒绝”之后，再次调用wx.getUserInfo不再弹出，任你结束进程、清理缓存都没有，硬是要等大概十多分钟后，才会再次弹出询问框。这时候可别再点错了，否则又得等十多分钟。<br>这是小程序某个版本升级“升”出来的。在此之前我看过有些产品喜欢把wx.getUserInfo设计成用户主动点击按钮去获取的事件,例如设计一颗“登录”按钮，用户一点击就调用wx.getUserInfo，用户点击“允许”就相当于登录了；这个“十多分钟不弹出”的特性升级之后，以前这类主动登录的模式就得改改了。</li>
<li><strong>内置的Promise被废除。</strong>一开始看到小程序支持ES6，支持Promise的时候非常高兴，想着可以写更优雅的异步代码块了。谁知道在某个版本升级之后，Promise就不被支持了，实在不知何故。虽然说有一些例如es6-promise的第三方框架可以代替，但不是终归总是不爽。</li>
<li><strong>地理位置API，获取不了当前坐标对应的地名。</strong>我一怒之下使用百度地图API实现了，还是终归不爽。</li>
</ul>
<h2 id="FOR-FUN"><a href="#FOR-FUN" class="headerlink" title="FOR FUN"></a>FOR FUN</h2><ul>
<li>说个血泪小教训，调试微信支付的时候千万千万不要用银行卡或信用卡去测试，频繁的支付1分钱1毛钱1块钱，会导致卡被银行封掉，有图有真相。<br><img src="http://i.imgur.com/1gqrCsq.jpg" alt=""></li>
<li>用内置的DB console可以查看案例的运营数据，观摩一下。读者可以看出谁赞赏了最多，最多又是多少钱吗？<br><img src="http://i.imgur.com/RJjeB0b.png" alt=""></li>
</ul>
<p>（完）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/12/微信小程序后台开发实例/" data-id="cjep9mrp5000jzco0q4h4fm2h" class="article-share-link">Teilen</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/18/php学习/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          php学习
        
      </div>
    </a>
  
  
    <a href="/2017/12/11/浙江工商大学智商杯ctf杂项官方writeup/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">浙江工商大学智商杯ctf杂项官方writeup</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/12/csrf学习/">web学习</a>
          </li>
        
          <li>
            <a href="/2018/03/10/sql注入的预防/">sql注入的预防</a>
          </li>
        
          <li>
            <a href="/2018/03/06/渗透测试流程-1/">渗透测试流程</a>
          </li>
        
          <li>
            <a href="/2018/01/19/xss简介/">xss学习</a>
          </li>
        
          <li>
            <a href="/2018/01/08/上传漏洞fckeditor的利用/">上传漏洞fckeditor的利用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 BlackManba<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>